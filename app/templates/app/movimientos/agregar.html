{% extends 'app/base.html' %}
{% load static %}

{% block contenido %}
  {% load crispy_forms_tags %}

  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
              <i class="fas fa-calendar-plus me-2"></i>
              {{ titulo }} - {{ entity.nombre }}
            </h4>
          </div>
          <div class="card-body">
            {% if form.errors %}
              <div class="alert alert-danger">
                <strong>Errores en el formulario:</strong>
                <ul>
                  {% for field, errors in form.errors.items %}
                    <li>
                      <strong>{{ field }}:</strong>
                      <ul>
                        {% for error in errors %}
                          <li>{{ error }}</li>
                        {% endfor %}
                      </ul>
                    </li>
                  {% endfor %}
                  {% if form.non_field_errors %}
                    <li>
                      <strong>Errores generales:</strong>
                      <ul>
                        {% for error in form.non_field_errors %}
                          <li>{{ error }}</li>
                        {% endfor %}
                      </ul>
                    </li>
                  {% endif %}
                </ul>
              </div>
            {% endif %}
            <form method="post">
              {% csrf_token %}

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Fecha y Hora *</label>
                  {{ form.fecha }}
                  {% if form.fecha.errors %}
                    <div class="text-danger">{{ form.fecha.errors }}</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label">Tipo de Movimiento *</label>
                  {{ form.tipo }}
                  {% if form.tipo.errors %}
                    <div class="text-danger">{{ form.tipo.errors }}</div>
                  {% endif %}
                </div>
              </div>
              <!-- Visa o Residente inmobiliario -->
              <div id="visa_group">{{ form.visa|as_crispy_field }}</div>
              {% if form.visa.errors %}
                <div class="text-danger">{{ form.visa.errors }}</div>
              {% endif %}
              <div id="tipo_visa_group">
                {{ form.tipo_visa|as_crispy_field }}
                {% if form.tipo_visa.errors %}
                  <div class="text-danger">{{ form.tipo_visa.errors }}</div>
                {% endif %}
                {{ form.fecha_visa|as_crispy_field }}
                {% if form.fecha_visa.errors %}
                  <div class="text-danger">{{ form.fecha_visa.errors }}</div>
                {% endif %}
              </div>
              <div id="residente_inmobiliario_group">{{ form.residente_inmobiliario|as_crispy_field }}</div>
              {% if form.residente_inmobiliario.errors %}
                <div class="text-danger">{{ form.residente_inmobiliario.errors }}</div>
              {% endif %}
              <div class="mb-3">
                <label class="form-label">Observaciones</label>
                {{ form.observaciones }}
                {% if form.observaciones.errors %}
                  <div class="text-danger">{{ form.observaciones.errors }}</div>
                {% endif %}
              </div>

              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-save me-1"></i>
                  {% if editar %}
                    Actualizar
                  {% else %}
                    Registrar
                  {% endif %}Movimiento
                </button>
                <a href="{% url 'listar_propietarios_edificio' edificio.id %}" class="btn btn-secondary"><i class="fas fa-times me-1"></i> Cancelar</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    input[type='datetime-local'] {
      padding: 0.375rem 0.75rem;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
    }
    
    #visa_group {
      transition: all 0.3s ease;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    #tipo_visa_group {
      transition: all 0.3s ease;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border-left: 4px solid #dc3545;
      margin-bottom: 20px;
    }
    
    #tipo_visa_group .form-control {
      background-color: white;
    }
    #residente_inmobiliario_group {
      transition: all 0.3s ease;
      border-radius: 5px;
      margin-bottom: 20px;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      //for visa and residente_inmobiliario
      const tipo = document.getElementById('{{ form.tipo.id_for_label }}')
      const residenteCheckbox = document.getElementById('{{ form.residente_inmobiliario.id_for_label }}')
      const residenteInmobiliarioGroup = document.getElementById('residente_inmobiliario_group')
      const visaCheckbox = document.getElementById('{{ form.visa.id_for_label }}')
      const visaGroup = document.getElementById('visa_group')
      const tipoVisaField = document.getElementById('{{ form.tipo_visa.id_for_label }}')
      const fechaVisaField = document.getElementById('{{ form.fecha_visa.id_for_label }}')
      const tipoVisaGroup = document.getElementById('tipo_visa_group')
    
      function toggleVisaFields() {
        // Ocultar/mostrar campos de visa basado en tipo
        if (tipo.value == 'entrada') {
          visaGroup.style.display = 'block'
          residenteInmobiliarioGroup.style.display = 'block'
          if (visaCheckbox.checked) {
            tipoVisaGroup.style.display = 'block'
            tipoVisaField.setAttribute('required', 'required')
            fechaVisaField.setAttribute('required', 'required')
          } else {
            tipoVisaGroup.style.display = 'none'
            tipoVisaField.removeAttribute('required')
            tipoVisaField.value = null
            fechaVisaField.removeAttribute('required')
            fechaVisaField.value = null
          }
        } else {
          visaGroup.style.display = 'none'
          visaCheckbox.checked = false
          tipoVisaGroup.style.display = 'none'
          tipoVisaField.removeAttribute('required')
          tipoVisaField.value = null
          fechaVisaField.removeAttribute('required')
          fechaVisaField.value = null
          residenteInmobiliarioGroup.style.display = 'none'
          residenteCheckbox.checked = false
        }
    
        // LÃ³gica de exclusividad entre residente_inmobiliario y visa
        if (residenteCheckbox.checked) {
          visaGroup.style.display = 'none'
          visaCheckbox.checked = false
          tipoVisaGroup.style.display = 'none'
          tipoVisaField.removeAttribute('required')
          tipoVisaField.value = ''
          fechaVisaField.removeAttribute('required')
          fechaVisaField.value = ''
        } else if (visaCheckbox.checked) {
          residenteInmobiliarioGroup.style.display = 'none'
          residenteCheckbox.checked = false
        } else {
          if (tipo.value == 'entrada') {
            visaGroup.style.display = 'block'
            residenteInmobiliarioGroup.style.display = 'block'
          } else {
            visaGroup.style.display = 'none'
            residenteInmobiliarioGroup.style.display = 'none'
          }
        }
      }
      // Event listener para el checkbox
      tipo.addEventListener('change', toggleVisaFields)
      visaCheckbox.addEventListener('change', toggleVisaFields)
      residenteCheckbox.addEventListener('change', toggleVisaFields)
    
      // Estado inicial
      toggleVisaFields()
    })
  </script>
{% endblock %}
